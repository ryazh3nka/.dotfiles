#!/bin/sh
set -e

playlists=$(mpc lsplaylists)
queue=$(mpc playlist)
database=$(mpc ls)

spawn_menu()
{
    printf '%s' "$1" | bemenu --prompt "$2" --list 20
}

choose_album()
{
    album=$(spawn_menu "$database" 'Choose an album:')
    echo "$album"
}

choose_song()
{
    album=$(choose_album)
    songs=$(mpc ls "$album" | sed 's|.*/||' | sort -V)
    song=$(spawn_menu "$songs" 'Choose a song:')
    echo "$album/$song"
}

queue_choose_song()
{
    song=$(spawn_menu "$queue" 'Choose a song:')
    echo "$song"
}

queue_get_song_position()
{
    song=$(queue_choose_song)
    song_pos=$(mpc playlist | grep -n "$song" | sed 's|:.*||')
    echo "$song_pos"
}

choose_playlist()
{
    playlist=$(spawn_menu "$playlists" 'Choose a playlist:')
    echo "$playlist"
}

options='Add album to queue
Add song to queue
Insert song to queue
Remove song from queue
Load playlist
Clear queue
Crop queue
Update database
Toggle repeat
Toggle single
Toggle playback
'

action=$(spawn_menu "$options" 'Run mpc command:')
case "$action" in
    'Add album to queue')
        album=$(choose_album)
        mpc add "$album" ;;
    'Add song to queue')
        song=$(choose_song)
        mpc add "$song" ;;
    'Insert song to queue')
        song=$(choose_song)
        mpc insert "$song" ;;
    'Remove song from queue')
        song_pos=$(queue_get_song_position)
        mpc del "$song_pos" ;;
    'Load playlist')
        playlist=$(choose_playlist)
        mpc load "$playlist" ;;
    'Clear queue') mpc clear ;;
    'Crop queue') mpc crop ;;
    'Update database') mpc update ;;
    'Toggle repeat') mpc repeat ;;
    'Toggle single') mpc single ;;
    'Toggle playback') mpc toggle ;;
esac
