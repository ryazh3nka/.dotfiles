#!/bin/sh
set -e

playlists=$(mpc lsplaylists)
queue=$(mpc playlist)
database=$(mpc ls)

spawn_menu()
{
    printf '%s' "$1" | bemenu --prompt "$2" --list 20
}

choose_album()
{
    album=$(spawn_menu "$database" 'Choose an album:')
    echo "$album"
}

album_choose_song()
{
    album="$1"
    songs=$(mpc ls "$album" | sed 's|.*/||' | sort -V)
    song=$(spawn_menu "$songs" 'Choose a song:')
    echo "$album/$song"
}

queue_choose_song()
{
    song=$(spawn_menu "$queue" 'Choose a song:')
    echo "$song"
}

queue_get_song_position()
{
    song="$1"
    song_pos=$(mpc playlist | grep -n "$song" | sed 's|:.*||')
    echo "$song_pos"
}

choose_playlist()
{
    playlist=$(spawn_menu "$playlists" 'Choose a playlist:')
    echo "$playlist"
}

options='Add an album to the queue
Add a song to the queue
Insert a song to the queue
Jump to a song in the queue
Remove a song from the queue
Load a playlist
Clear the queue
Crop the queue
Update the database
Toggle repeat
Toggle single
Toggle playback
'

action=$(spawn_menu "$options" 'Run mpc command:')
case "$action" in
    'Add an album to the queue')
        album=$(choose_album)
        mpc add "$album" ;;
    'Add a song to the queue')
        album=$(choose_album)
        song=$(album_choose_song "$album")
        mpc add "$song" ;;
    'Insert a song to the queue')
        album=$(choose_album)
        song=$(album_choose_song "$album")
        mpc insert "$song" ;;
    'Jump to a song in the queue')
        song=$(queue_choose_song)
        song_pos=$(queue_get_song_position "$song")
        mpc play "$song_pos" ;;
    'Remove a song from the queue')
        song=$(queue_choose_song)
        song_pos=$(queue_get_song_position "$song")
        mpc del "$song_pos" ;;
    'Load a playlist')
        playlist=$(choose_playlist)
        mpc load "$playlist" ;;
    'Clear the queue') mpc clear ;;
    'Crop the queue') mpc crop ;;
    'Update the database') mpc update ;;
    'Toggle repeat') mpc repeat ;;
    'Toggle single') mpc single ;;
    'Toggle playback') mpc toggle ;;
esac
